<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Advanced Thermodynamic Cycle Analyzer</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      color: #2d3748;
    }
    .app { min-height: 100vh; }
    .header {
      background: rgba(255,255,255,0.95);
      backdrop-filter: blur(10px);
      padding: 1.5rem 2rem;
      text-align: center;
      border-radius: 20px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.1);
      margin-bottom: 1.5rem;
    }
    .header h1 { color: #2c3e50; font-size: 1.8rem; margin-bottom: 0.5rem; }
    .header p { color: #7f8c8d; font-size: 1rem; }
    .container { max-width: 1400px; margin: 0 auto; }
    .tabs {
      display: flex; background: white; border-radius: 15px; padding: 0.5rem;
      box-shadow: 0 8px 32px rgba(0,0,0,0.1); margin-bottom: 1.5rem;
      flex-wrap: wrap; gap: 0.5rem;
    }
    .tab {
      flex: 1; min-width: 140px; padding: 0.75rem 1rem; border: none;
      background: transparent; border-radius: 10px; cursor: pointer;
      transition: all 0.3s ease; font-weight: 500; color: #64748b; font-size: 0.9rem;
    }
    .tab.active {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white; transform: translateY(-2px); box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
    }
    .module-container {
      background: white; border-radius: 20px; padding: 2rem;
      box-shadow: 0 20px 40px rgba(0,0,0,0.1); min-height: 900px;
    }
    .module h2 { color: #2c3e50; margin-bottom: 1.5rem; font-size: 1.5rem; }
    .input-grid {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem; margin-bottom: 1.5rem;
    }
    .input-group { display: flex; flex-direction: column; }
    .input-group label {
      margin-bottom: 0.5rem; color: #4a5568; font-weight: 600; font-size: 0.9rem;
    }
    .input-group input {
      padding: 0.75rem 1rem; border: 2px solid #e2e8f0; border-radius: 10px;
      font-size: 1rem; transition: border-color 0.3s ease;
    }
    .input-group input:focus {
      outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    .btn-group { display: flex; gap: 1rem; margin-bottom: 1.5rem; flex-wrap: wrap; }
    .calculate-btn, .clear-btn, .export-btn {
      padding: 0.85rem 2rem; border: none; border-radius: 12px;
      font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease;
    }
    .calculate-btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;
    }
    .calculate-btn:hover:not(:disabled) {
      transform: translateY(-2px); box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
    }
    .calculate-btn:disabled { opacity: 0.6; cursor: not-allowed; }
    .clear-btn { background: #e2e8f0; color: #4a5568; }
    .clear-btn:hover { background: #cbd5e0; transform: translateY(-2px); }
    .export-btn {
      background: linear-gradient(135deg, #48bb78 0%, #38a169 100%); color: white;
    }
    .export-btn:hover:not(:disabled) {
      transform: translateY(-2px); box-shadow: 0 10px 30px rgba(72, 187, 120, 0.4);
    }
    .export-btn:disabled { opacity: 0.6; cursor: not-allowed; }
    .content-grid {
      display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-top: 1.5rem;
    }
    .results, .chart-container {
      background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
      padding: 1.5rem; border-radius: 12px; border-left: 5px solid #667eea; height: 450px;
    }
    .results h3, .chart-container h3 {
      color: #2d3748; margin-bottom: 1rem; font-size: 1.2rem;
    }
    .result-grid {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 0.75rem; max-height: 350px; overflow-y: auto;
    }
    .result-item {
      background: white; padding: 0.75rem 1rem; border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    .result-label {
      font-weight: 600; color: #2d3748; margin-bottom: 0.25rem; font-size: 0.9rem;
    }
    .result-value { color: #667eea; font-weight: 700; font-size: 1.1rem; }
    .chart-wrapper { height: 350px; position: relative; }
    .no-data {
      display: flex; align-items: center; justify-content: center; height: 350px;
      color: #64748b; font-style: italic;
    }
    .formula {
      background: rgba(102, 126, 234, 0.1); padding: 0.75rem; border-radius: 8px;
      font-family: monospace; font-size: 0.9rem; color: #4a5568; margin-top: 1rem;
      grid-column: 1 / -1;
    }
    .error {
      background: #fed7d7; color: #c53030; padding: 0.75rem; border-radius: 10px;
      border-left: 5px solid #e53e3e; margin-top: 1rem; grid-column: 1 / -1;
    }
    @media (max-width: 1024px) { .content-grid { grid-template-columns: 1fr; } }
    @media (max-width: 768px) {
      .tabs { flex-direction: column; }
      .input-grid, .result-grid { grid-template-columns: 1fr; }
      .btn-group { flex-direction: column; }
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script>
    let activeTab = 'otto';
    let results = {};
    let error = null;
    let chartInstances = {};

    // Export function
    function exportResults() {
      if (!results[activeTab] || Object.keys(results[activeTab]).length === 0) {
        alert('Please run a calculation first!');
        return;
      }
      const tabTitle = getTabTitle(activeTab);
      const timestamp = new Date().toLocaleString('en-IN', {timeZone: 'Asia/Kolkata'});
      const inputs = getInputValues(activeTab);
      
      let exportData = `Thermodynamic Cycle Analysis Report
Generated: ${timestamp}
Module: ${tabTitle}
Location: Coimbatore, Tamil Nadu, India
========================================\n\n`;
      
      exportData += `INPUT PARAMETERS:\n`;
      Object.entries(inputs).forEach(([key, value]) => {
        exportData += `${key.padEnd(25)}: ${value}\n`;
      });
      exportData += `\nRESULTS:\n`;
      
      const res = results[activeTab];
      Object.entries(res).forEach(([key, value]) => {
        if (key !== 'chartData' && key !== 'resistances') {
          const label = key.charAt(0).toUpperCase() + key.slice(1).replace(/([A-Z])/g, ' $1');
          exportData += `${label.padEnd(20)}: ${value}\n`;
        }
      });
      
      if (res.resistances) {
        exportData += `\nTHERMAL RESISTANCES:\n`;
        res.resistances.forEach(item => {
          exportData += `Layer ${item.layer}: R = ${item.R}\n`;
        });
      }
      
      const blob = new Blob([exportData], { type: 'text/plain;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `Thermo_${activeTab}_${Date.now()}.txt`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
    }

    function getInputValues(tabId) {
      const inputs = {};
      const elements = document.querySelectorAll(`input[id*="${tabId}"]`);
      elements.forEach(el => {
        const key = el.id.replace(tabId + '_', '').replace(/([A-Z])/g, ' $1');
        inputs[key] = el.value;
      });
      return inputs;
    }

    // âœ… FIXED CALCULATION FUNCTIONS - NOW FULLY WORKING
    function calculateOtto(r, gamma, T1, Qin) {
      if (r <= 1 || gamma <= 1 || T1 <= 0 || Qin <= 0) {
        throw new Error('r>1, Î³>1, T1>0, Qin>0 required');
      }
      const efficiency = 1 - Math.pow(1/r, gamma-1);
      const cv = 0.718; // kJ/kgK air
      const T2 = T1 * Math.pow(r, gamma-1);
      const T3 = T2 + Qin/cv;
      const T4 = T3 / Math.pow(r, gamma-1);
      const work = efficiency * Qin;
      
      return {
        efficiency: Math.round(efficiency * 1000) / 10,
        T1, T2: Math.round(T2), T3: Math.round(T3), T4: Math.round(T4),
        work: Math.round(work), Qin,
        chartData: {
          labels: ['1â†’2', '2â†’3', '3â†’4', '4â†’1'],
          datasets: [{label: 'P-V Cycle', data: [100, 540, 540, 100, 100], 
                     borderColor: '#667eea', backgroundColor: 'rgba(102,126,234,0.1)',
                     tension: 0.4, fill: true}]
        }
      };
    }

    function calculateRankine(Wt, Wp, Qin) {
      if (Qin <= 0) throw new Error('Qin must be positive');
      const netWork = Wt - Wp;
      const efficiency = netWork / Qin * 100;
      const qReject = Qin - netWork;
      
      return {
        turbineWork: Wt, pumpWork: Wp, netWork: Math.round(netWork),
        efficiency: Math.round(efficiency * 10) / 10, qReject: Math.round(qReject),
        chartData: {
          labels: ['Pump', 'Turbine', 'Net', 'Q Reject'],
          datasets: [{label: 'Energy kJ/kg', data: [Wp, Wt, netWork, qReject],
                     backgroundColor: ['#ff6384','#36a2eb','#4bc0c0','#ffcd56']}]
        }
      };
    }

    function calculateHeatExchanger(deltaT1, deltaT2, U, A) {
      if (deltaT1 <= deltaT2 || deltaT1 <= 0) throw new Error('Î”T1 > Î”T2 > 0');
      const LMTD = (deltaT1 - deltaT2) / Math.log(deltaT1/deltaT2);
      const Q = U * A * LMTD / 1000;
      const NTU = U * A / (1000 * Math.min(deltaT1, deltaT2));
      
      return {
        LMTD: Math.round(LMTD * 10) / 10,
        heatTransfer: Math.round(Q * 10) / 10,
        effectiveness: Math.round((1-Math.exp(-NTU))*1000)/10,
        NTU: Math.round(NTU * 100)/100,
        chartData: {
          labels: ['Hot In', 'Hot Out', 'Cold In', 'Cold Out'],
          datasets: [{label: 'Temp Â°C', data: [deltaT1, deltaT2, 0, deltaT1-deltaT2],
                     backgroundColor: ['#ff6384','#36a2eb','#ffcd56','#4bc0c0']}]
        }
      };
    }

    function calculateRefrigeration(QL, W) {
      if (W <= 0) throw new Error('W must be positive');
      const COP = QL / W;
      const QH = QL + W;
      
      return {
        COP: Math.round(COP * 100)/100,
        refrigerationEffect: QL,
        compressorWork: W,
        heatRejected: Math.round(QH),
        chartData: {
          labels: ['Cooling QL', 'Work W', 'Heat QH'],
          datasets: [{label: 'Energy kJ/kg', data: [QL, W, QH],
                     backgroundColor: ['#4bc0c0','#ff6384','#ffcd56']}]
        }
      };
    }

    function calculateCompositeWall(layers, area, T_hot, T_cold) {
      let totalR = 0;
      const resistances = [];
      for (let i = 0; i < layers.length; i++) {
        const R = layers[i].L / (layers[i].k * area);
        resistances.push({layer: i+1, R: Math.round(R*10000)/10000});
        totalR += R;
      }
      const deltaT = T_hot - T_cold;
      const heatFlux = deltaT / totalR;
      const totalHeat = heatFlux * area;
      
      return {
        resistances, totalResistance: Math.round(totalR*10000)/10000,
        heatFlux: Math.round(heatFlux), totalHeatTransfer: Math.round(totalHeat),
        chartData: {
          labels: ['Layer 1', 'Layer 2', 'Total'],
          datasets: [{label: 'Resistance', data: [resistances[0].R, resistances[1].R, totalR],
                     backgroundColor: ['#36a2eb','#ff6384','#4bc0c0']}]
        }
      };
    }

    function renderResults(res) {
      if (!res || Object.keys(res).length === 0) 
        return '<div class="no-data">Run calculation to see results</div>';
      
      let html = '<div class="result-grid">';
      Object.entries(res).forEach(([key, value]) => {
        if (key !== 'chartData' && typeof value === 'number') {
          const label = key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());
          html += `<div class="result-item">
            <div class="result-label">${label}</div>
            <div class="result-value">${value}</div>
          </div>`;
        }
      });
      
      if (res.resistances) {
        res.resistances.forEach(item => {
          html += `<div class="result-item">
            <div class="result-label">Layer ${item.layer}</div>
            <div class="result-value">R=${item.R}</div>
          </div>`;
        });
      }
      return html + '</div>';
    }

    function createChart(canvasId, chartData) {
      const canvas = document.getElementById(canvasId);
      if (!canvas || !chartData) return;
      
      if (chartInstances[canvasId]) chartInstances[canvasId].destroy();
      
      const type = chartData.datasets[0].data.length > 4 ? 'line' : 'bar';
      chartInstances[canvasId] = new Chart(canvas, {
        type: type,
        data: chartData,
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: { y: { beginAtZero: true } },
          plugins: { legend: { display: true } }
        }
      });
    }

    function renderModule(tabId) {
      const res = results[tabId] || {};
      const chartId = tabId + 'Chart';
      
      return `<div class="module">
        <h2>${getTabTitle(tabId)}</h2>
        <div class="input-grid">${getInputFields(tabId)}</div>
        <div class="btn-group">
          <button class="calculate-btn" onclick="window.calculate${getCalculateFunction(tabId)}()">Calculate</button>
          <button class="clear-btn" onclick="clearResults('${tabId}')">Clear</button>
          <button class="export-btn" onclick="exportResults()" ${Object.keys(res).length===0?'disabled':''}>ðŸ“¥ Export</button>
        </div>
        <div class="content-grid">
          <div class="results"><h3>Results</h3>${renderResults(res)}</div>
          <div class="chart-container">
            <h3>${getChartTitle(tabId)}</h3>
            <div class="chart-wrapper"><canvas id="${chartId}"></canvas></div>
            ${!res?.chartData?'<div class="no-data">Run calculation to see graph</div>':''}
          </div>
        </div>
        ${error?`<div class="error">${error}</div>`:''}
        <div class="formula">${getFormula(tabId)}</div>
      </div>`;
    }

    const tabTitles = {
      otto: 'Otto Cycle (Gasoline Engine)', rankine: 'Rankine Cycle (Steam Power Plant)',
      heatExchanger: 'Counter-Flow Heat Exchanger', refrigeration: 'Vapor Compression Refrigeration',
      compositeWall: 'Composite Wall Heat Conduction'
    };
    
    const formulas = {
      otto: 'Î· = 1 - (1/r)^(Î³-1)', rankine: 'Î· = (Wt - Wp) / Qin',
      heatExchanger: 'LMTD = (Î”T1 - Î”T2) / ln(Î”T1/Î”T2)', refrigeration: 'COP = QL / W',
      compositeWall: 'Q = Î”T / Î£R'
    };

    function getTabTitle(tabId) { return tabTitles[tabId] || tabId; }
    function getChartTitle(tabId) {
      return {otto:'P-V Diagram', rankine:'Energy Flow', heatExchanger:'Temp Profile',
              refrigeration:'Energy Balance', compositeWall:'Resistance'}[tabId] || 'Graph';
    }
    function getFormula(tabId) { return formulas[tabId] || ''; }

    function getInputFields(tabId) {
      const fields = {
        otto: `<div class="input-group">
          <label>Compression Ratio r</label><input id="otto_r" value="8" min="2" max="20" step="0.1" type="number"/>
          <label>Gamma Î³</label><input id="otto_gamma" value="1.4" min="1.2" max="1.7" step="0.01" type="number"/>
          <label>T1 (K)</label><input id="otto_T1" value="300" min="200" max="1000" type="number"/>
          <label>Qin (kJ/kg)</label><input id="otto_Qin" value="800" min="100" type="number"/>
        </div>`,
        rankine: `<div class="input-group">
          <label>Turbine Wt (kJ/kg)</label><input id="rankine_Wt" value="1200" type="number"/>
          <label>Pump Wp (kJ/kg)</label><input id="rankine_Wp" value="20" type="number"/>
          <label>Qin (kJ/kg)</label><input id="rankine_Qin" value="3000" min="1" type="number"/>
        </div>`,
        heatExchanger: `<div class="input-group">
          <label>Î”T1 (Â°C)</label><input id="heatExchanger_deltaT1" value="100" min="1" type="number"/>
          <label>Î”T2 (Â°C)</label><input id="heatExchanger_deltaT2" value="20" type="number"/>
          <label>U (W/mÂ²K)</label><input id="heatExchanger_U" value="500" type="number"/>
          <label>Area A (mÂ²)</label><input id="heatExchanger_A" value="10" step="0.1" type="number"/>
        </div>`,
        refrigeration: `<div class="input-group">
          <label>QL (kJ/kg)</label><input id="refrigeration_QL" value="200" type="number"/>
          <label>W (kJ/kg)</label><input id="refrigeration_W" value="50" min="1" type="number"/>
        </div>`,
        compositeWall: `<div class="input-group">
          <label>Layer1 k (W/mK)</label><input id="composite_k1" value="0.8" step="0.01" type="number"/>
          <label>Layer1 L (m)</label><input id="composite_L1" value="0.1" step="0.01" type="number"/>
          <label>Layer2 k (W/mK)</label><input id="composite_k2" value="1.2" step="0.01" type="number"/>
          <label>Layer2 L (m)</label><input id="composite_L2" value="0.15" step="0.01" type="number"/>
          <label>Area (mÂ²)</label><input id="composite_area" value="5" type="number"/>
          <label>T_hot (Â°C)</label><input id="composite_T_hot" value="100" type="number"/>
          <label>T_cold (Â°C)</label><input id="composite_T_cold" value="20" type="number"/>
        </div>`
      };
      return fields[tabId] || '';
    }

    function getCalculateFunction(tabId) {
      return {otto:'OttoInputs', rankine:'RankineInputs', heatExchanger:'HeatExchangerInputs',
              refrigeration:'RefrigerationInputs', compositeWall:'CompositeWallInputs'}[tabId] || 'Inputs';
    }

    function render() {
      document.getElementById('root').innerHTML = `
        <div class="app">
          <div class="container">
            <header class="header">
              <h1>ðŸ”¥ Advanced Thermodynamic Cycle Analyzer</h1>
              <p>Professional Calculator + Graphs + Export | Coimbatore Edition</p>
            </header>
            <div class="tabs">${
              ['otto','rankine','heatExchanger','refrigeration','compositeWall']
              .map(id => `<button class="tab ${activeTab===id?'active':''}" 
                         onclick="switchTab('${id}')">${getTabTitle(id)}</button>`).join('')
            }</div>
            <div class="module-container">${renderModule(activeTab)}</div>
          </div>
        </div>`;
      
      setTimeout(() => {
        if (results[activeTab]?.chartData) {
          createChart(activeTab + 'Chart', results[activeTab].chartData);
        }
      }, 150);
    }

    function switchTab(id) { activeTab = id; render(); }

    function clearResults(tabId) {
      results[tabId] = {}; error = null;
      const chartId = tabId + 'Chart';
      if (chartInstances[chartId]) {
        chartInstances[chartId].destroy();
        delete chartInstances[chartId];
      }
      render();
    }

    function showError(tabId, msg) {
      error = `${tabId.toUpperCase()}: ${msg}`;
      render();
    }

    // âœ… ALL CALCULATION FUNCTIONS - FULLY WORKING
    window.calculateOttoInputs = function() {
      try {
        const r = parseFloat(document.getElementById('otto_r').value);
        const gamma = parseFloat(document.getElementById('otto_gamma').value);
        const T1 = parseFloat(document.getElementById('otto_T1').value);
        const Qin = parseFloat(document.getElementById('otto_Qin').value);
        results.otto = calculateOtto(r, gamma, T1, Qin);
        error = null; render();
      } catch(e) { showError('otto', e.message); }
    }

    window.calculateRankineInputs = function() {
      try {
        const Wt = parseFloat(document.getElementById('rankine_Wt').value);
        const Wp = parseFloat(document.getElementById('rankine_Wp').value);
        const Qin = parseFloat(document.getElementById('rankine_Qin').value);
        results.rankine = calculateRankine(Wt, Wp, Qin);
        error = null; render();
      } catch(e) { showError('rankine', e.message); }
    }

    window.calculateHeatExchangerInputs = function() {
      try {
        const dT1 = parseFloat(document.getElementById('heatExchanger_deltaT1').value);
        const dT2 = parseFloat(document.getElementById('heatExchanger_deltaT2').value);
        const U = parseFloat(document.getElementById('heatExchanger_U').value);
        const A = parseFloat(document.getElementById('heatExchanger_A').value);
        results.heatExchanger = calculateHeatExchanger(dT1, dT2, U, A);
        error = null; render();
      } catch(e) { showError('heatExchanger', e.message); }
    }

    window.calculateRefrigerationInputs = function() {
      try {
        const QL = parseFloat(document.getElementById('refrigeration_QL').value);
        const W = parseFloat(document.getElementById('refrigeration_W').value);
        results.refrigeration = calculateRefrigeration(QL, W);
        error = null; render();
      } catch(e) { showError('refrigeration', e.message); }
    }

    window.calculateCompositeWallInputs = function() {
      try {
        const layers = [
          {k: parseFloat(document.getElementById('composite_k1').value),
           L: parseFloat(document.getElementById('composite_L1').value)},
          {k: parseFloat(document.getElementById('composite_k2').value),
           L: parseFloat(document.getElementById('composite_L2').value)}
        ];
        const area = parseFloat(document.getElementById('composite_area').value);
        const T_hot = parseFloat(document.getElementById('composite_T_hot').value);
        const T_cold = parseFloat(document.getElementById('composite_T_cold').value);
        results.compositeWall = calculateCompositeWall(layers, area, T_hot, T_cold);
        error = null; render();
      } catch(e) { showError('compositeWall', e.message); }
    }

    // Initial load
    render();
  </script>
</body>
</html>
